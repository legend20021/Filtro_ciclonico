<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta Profesional de C√°lculo de Filtro Cicl√≥nico v9.5 (Penagos Edition)</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Segoe+UI:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-dark: #111827; --bg-light: #f3f4f6;
            --text-dark: #E5E7EB; --text-light: #1f2937;
            --card-bg-dark: rgba(31, 41, 55, 0.5); --card-bg-light: #ffffff;
            --border-dark: rgba(34, 211, 238, 0.3); --border-light: #d1d5db;
            --primary-dark: #22d3ee; --primary-light: #1d4ed8;
            --input-bg-dark: rgba(17, 24, 39, 0.8); --input-bg-light: #e5e7eb;
            --icon-color-dark: var(--text-dark); --icon-color-light: var(--text-light);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark); color: var(--text-dark);
            overflow-x: hidden;
            overflow-y: scroll;
        }
        
        /* --- CONTROLS & THEME BUTTON --- */
        .header-controls { position: absolute; top: 10px; right: 20px; display: flex; align-items: center; gap: 15px; z-index: 100; }
        .btn-icon { background: transparent; border: none; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .btn-icon svg { width: 24px; height: 24px; color: var(--icon-color-dark); }
        .btn-icon:hover { background-color: rgba(255, 255, 255, 0.1); }
        .password-wrapper { position: relative; }
        #togglePassword { position: absolute; right: 0; top: 50%; transform: translateY(-50%); height: 100%; padding: 0 12px; }
        #togglePassword svg { width: 20px; height: 20px; }
        
        /* --- LIGHT MODE STYLES --- */
        body.light-mode { background-color: var(--bg-light); color: var(--text-light); }
        body.light-mode .btn-icon svg { color: var(--icon-color-light); }
        body.light-mode .btn-icon:hover { background-color: rgba(0, 0, 0, 0.05); }
        body.light-mode #login-overlay { background-color: var(--bg-light); }
        body.light-mode .particles li { background: rgba(29, 78, 216, 0.15); }
        body.light-mode .login-box { background: rgba(255, 255, 255, 0.6); border-color: #a5b4fc; color: #111827; }
        body.light-mode .login-box h1 { color: var(--primary-light); text-shadow: none; }
        body.light-mode .login-box p { color: #4b5563; }
        body.light-mode .login-field label { color: #374151; }
        body.light-mode .login-field input { background: var(--input-bg-light); border-color: #9ca3af; color: #111827; }
        body.light-mode .login-field input:focus { border-color: var(--primary-light); box-shadow: 0 0 15px rgba(29, 78, 216, 0.4); }
        body.light-mode .login-button { background: var(--primary-light); color: #fff; }
        body.light-mode .login-button:hover { background: #1e40af; }
        body.light-mode .step-card { background: var(--card-bg-light); border: 1px solid var(--border-light); color: var(--text-light); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        body.light-mode .header { color: var(--text-light); }
        body.light-mode .step-title { color: var(--primary-light); }
        body.light-mode .step-number { background: var(--primary-light); color: #fff; }
        body.light-mode .input-field h4 { color: #1e40af; border-color: #93c5fd; }
        body.light-mode label { color: #374151; }
        body.light-mode label small { color: #6b7280; }
        body.light-mode input, body.light-mode select { background: var(--input-bg-light); color: #111827; border: 1px solid #9ca3af; }
        body.light-mode input:focus, body.light-mode select:focus { border-color: var(--primary-light); box-shadow: 0 0 15px rgba(29, 78, 216, 0.4); }
        body.light-mode .calculation-display { background: #eef2ff; border-color: #a5b4fc; }
        body.light-mode .result-highlight { background: #f3f4f6; border-left-color: var(--primary-light); }
        body.light-mode .btn-primary { background: var(--primary-light); color: #fff; }
        body.light-mode .btn-primary:hover { background: #1e3a8a; transform: translateY(-2px); box-shadow: 0 0 20px rgba(29, 78, 216, 0.5); }
        body.light-mode .btn-secondary { background: #d1d5db; color: #1f2937; }
        body.light-mode .btn-secondary:hover { background: #9ca3af; }
        body.light-mode .btn:disabled { background: #e5e7eb; color: #9ca3af; }
        body.light-mode .next-button-pulse:not(:disabled) { animation-name: pulse-light; }
        body.light-mode .page-footer { background-color: rgba(255, 255, 255, 0.85); border-top: 1px solid rgba(0, 0, 0, 0.1); color: #374151; }
        body.light-mode .footer-left a { color: #1f2937; }
        body.light-mode .footer-left a:hover { color: var(--primary-light); }
        body.light-mode .footer-right { color: #4b5563; }
        body.light-mode .btn-logout { background: #fca5a5; color: #7f1d1d; }
        body.light-mode .btn-logout:hover { background: #f87171; }
        body.light-mode .final-report { background: #fff; border: 1px solid #e5e7eb; }
        body.light-mode .report-section h3 { color: #1e3a8a; border-bottom-color: #93c5fd; }
        body.light-mode .report-table td { border-color: #e5e7eb; color: #111827; }
        body.light-mode .report-table td:first-child { background-color: var(--primary-light); color: #fff; }
        body.light-mode .report-footer { color: #6b7280; border-top-color: #e5e7eb; }
        body.light-mode .report-section ul li { color: #111827; } 
        body.light-mode .report-section ul li::marker { color: var(--primary-light); }
        body.light-mode .collapsible-header { background-color: rgba(0, 0, 0, 0.05); }
        body.light-mode .collapsible-header:hover { background-color: rgba(0, 0, 0, 0.1); }
        body.light-mode .collapsible-content { border-color: var(--border-light); }

        /* --- CORE STYLES --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: flex; align-items: center; justify-content: center; background-color: var(--bg-dark); }
        #login-overlay.hidden { opacity: 0; pointer-events: none; }
        .login-box { background: var(--card-bg-dark); border: 1px solid var(--border-dark); padding: 40px; border-radius: 15px; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); text-align: center; color: var(--text-dark); width: 90%; max-width: 420px; animation: fadeInLogin 1s ease-out; }
        @keyframes fadeInLogin { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .login-logo { max-width: 200px; margin-bottom: 20px; }
        .login-box h1 { font-family: 'Orbitron', sans-serif; font-size: 24px; margin-bottom: 10px; color: var(--primary-dark); text-shadow: 0 0 10px var(--primary-dark); }
        .login-box p { margin-bottom: 30px; color: rgba(229, 231, 235, 0.7); }
        .login-field { margin-bottom: 20px; text-align: left; }
        .login-field label { display: block; margin-bottom: 8px; font-size: 14px; }
        .login-field input { width: 100%; padding: 12px; background: var(--input-bg-dark); border: 1px solid rgba(34, 211, 238, 0.4); border-radius: 8px; color: #fff; font-size: 16px; }
        .login-button { width: 100%; padding: 12px; border: none; border-radius: 8px; background: var(--primary-dark); color: #111827; font-size: 18px; font-weight: bold; font-family: 'Orbitron', sans-serif; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(34, 211, 238, 0.5); }
        .login-button:hover { background: #fff; box-shadow: 0 0 25px var(--primary-dark); }
        .login-box.error-shake { animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); } 20%, 40%, 60%, 80% { transform: translateX(10px); } }
        .app-wrapper { opacity: 0; transform: translateY(20px); transition: opacity 0.5s 0.4s ease-out, transform 0.5s 0.4s ease-out; padding-bottom: 90px; }
        .app-wrapper.visible { opacity: 1; transform: translateY(0); }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin: 20px 0; position: relative; }
        .btn-logout { padding: 8px 16px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; background-color: #7f1d1d; color: #fecaca; transition: background-color 0.3s; }
        .btn-logout:hover { background-color: #991b1b; }
        .header-logo { max-width: 250px; margin-top: 15px; margin-bottom: 15px; }
        .progress-bar { background: rgba(31, 41, 55, 0.5); border-radius: 25px; height: 50px; margin: 20px 0; position: relative; overflow: hidden; }
        .progress-fill { background: linear-gradient(90deg, #22d3ee, #00bfff); height: 100%; border-radius: 25px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: #111827; font-weight: bold; }
        .step-card { background: var(--card-bg-dark); border: 1px solid var(--border-dark); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); color: var(--text-dark); border-radius: 15px; padding: 30px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: none; animation: slideIn 0.5s ease; }
        .step-card.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { color: var(--primary-dark); font-size: 24px; margin-bottom: 20px; display: flex; align-items: center; }
        .step-number { background: var(--primary-dark); color: #111827; min-width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold; }
        .input-group { margin: 20px 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: start; }
        .input-field { display: flex; flex-direction: column; }
        .input-field h4 { color: #93c5fd; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #3b82f6; }
        label { font-weight: bold; margin-bottom: 5px; }
        label small { font-weight: normal; display: block; margin-top: 4px; line-height: 1.4; }
        input, select { padding: 12px; border-radius: 8px; font-size: 16px; width: 100%; background: var(--input-bg-dark); color: #fff; border: 1px solid rgba(34, 211, 238, 0.4); }
        .calculation-display { background: #1f2937; border: 1px solid var(--border-dark); border-radius: 10px; padding: 20px; margin: 15px 0; }
        .result-highlight { background: #374151; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid var(--primary-dark); }
        .buttons { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; gap: 15px; flex-wrap: wrap; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        .btn-primary { background: var(--primary-dark); color: #111827; }
        .btn-primary:hover { background: #fff; transform: translateY(-2px); box-shadow: 0 0 20px var(--primary-dark); }
        .btn-secondary { background: #4b5563; color: #e5e7eb; }
        .btn-secondary:hover { background: #6b7280; }
        .btn:disabled { background: #374151; color: #9ca3af; cursor: not-allowed; transform: none; animation: none !important; box-shadow: none; }
        .next-button-pulse:not(:disabled) { animation: pulse-dark 1.5s infinite; }
        @keyframes pulse-dark { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 211, 238, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(34, 211, 238, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 211, 238, 0); } }
        @keyframes pulse-light { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.6); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(29, 78, 216, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(29, 78, 216, 0); } }
        .final-report { background: var(--card-bg-dark); color: var(--text-dark); padding: 30px; border-radius: 15px; margin: 20px 0; border: 1px solid var(--border-dark); }
        .report-section h3 { color: var(--primary-dark); margin-top: 20px; border-bottom: 2px solid var(--primary-dark); padding-bottom: 5px; margin-bottom: 15px;}
        .report-section ul { list-style-position: inside; padding-left: 5px; margin-top: 10px; }
        .report-section li { margin-bottom: 8px; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .report-table td { padding: 8px; border: 1px solid #4b5563; font-size: 14px; }
        .report-table td:first-child { font-weight: bold; background-color: #374151; width: 50%; }
        .report-footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #4b5563; text-align: center; font-size: 12px; color: #9ca3af; }
        .page-footer { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1000; background-color: rgba(17, 24, 39, 0.85); -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); padding: 15px 25px; color: rgba(229, 231, 235, 0.8); text-align: center; border-top: 1px solid var(--border-dark); display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
        .footer-left a { color: #E5E7EB; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; transition: color 0.3s; }
        .footer-left a:hover { color: var(--primary-dark); }
        .footer-left svg { width: 22px; height: 22px; fill: currentColor; }
        .footer-right { font-weight: bold; color: #9ca3af; }

        /* --- Collapsible info boxes --- */
        .collapsible-header { cursor: pointer; padding: 10px; background-color: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-dark); border-radius: 6px; margin-top: 10px; font-weight: normal; font-size: 14px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s; }
        .collapsible-header:hover { background-color: rgba(255, 255, 255, 0.1); }
        .collapsible-content { display: none; padding: 15px; border: 1px solid var(--border-dark); border-top: none; border-radius: 0 0 6px 6px; font-size: 14px; background-color: rgba(0,0,0,0.2); }
        .collapsible-content.show { display: block; }
        .collapsible-header .arrow { font-size: 1.2em; transition: transform 0.3s; }
        .collapsible-header.active .arrow { transform: rotate(90deg); }
        
        .results-image-container { text-align: center; margin-top: 30px; }
        .results-image-container img { max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border-dark); margin-top: 15px; }
        .results-image-container p { font-size: 12px; color: #9ca3af; margin-top: 10px; }
        
        /* --- THEME TRANSITION ANIMATION --- */
        @keyframes wipe-in { from { clip-path: circle(0% at top left); } to { clip-path: circle(150% at top left); } }
        ::view-transition-new(*) { animation: wipe-in 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        ::view-transition-old(*) { animation: none; }

        /* --- STYLES FOR PDF RENDERING (Desktop View) --- */
        .pdf-render-prep { width: 1200px !important; }
        .pdf-render-prep .report-table,
        .pdf-render-prep .report-table tbody,
        .pdf-render-prep .report-table tr,
        .pdf-render-prep .report-table td { display: table !important; }
        .pdf-render-prep .report-table { width: 100% !important; border-collapse: collapse !important; }
        .pdf-render-prep .report-table tr { display: table-row !important; }
        .pdf-render-prep .report-table td { display: table-cell !important; text-align: left !important; float: none !important; }
        .pdf-render-prep .report-table td::before { content: none !important; }
        .pdf-render-prep .report-table td:first-child { width: 50% !important; }
        
        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 768px) {
            .header h1 { font-size: 24px; }
            .header p { font-size: 14px; }
            .header-logo { margin-top: 50px; }
            .step-title { font-size: 20px; flex-direction: column; align-items: flex-start; gap: 10px; }
            .step-card, .login-box { padding: 20px; }
            .container { padding: 10px; }
            .buttons { justify-content: center; }
            .page-footer { flex-direction: column; gap: 10px; padding: 10px; position: relative; }
            .app-wrapper { padding-bottom: 120px; }
            .progress-fill { font-size: 0; }

            /* Responsive Report Table */
            .report-table { border: 0; }
            .report-table thead { display: none; }
            .report-table tr { display: block; margin-bottom: 15px; border: 1px solid var(--border-light); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            body.light-mode .report-table tr { border-color: #e5e7eb; }
            .report-table td { display: block; text-align: right; border: 0; border-bottom: 1px dotted #6b7280; padding: 10px; }
            body.light-mode .report-table td { border-bottom: 1px dotted #d1d5db; }
            .report-table td:last-child { border-bottom: 0; }
            .report-table td:first-child { background-color: transparent !important; color: inherit !important; font-weight: normal; }
            .report-table td::before {
                content: attr(data-label);
                float: left;
                font-weight: bold;
                margin-right: 10px;
            }
        }
    </style>
</head>
<body>
    
    <div id="login-overlay">
        <div class="login-box" id="loginBox">
            <img src="https://penagos.com/wp-content/uploads/2020/04/logo-2-300x129.png" alt="Logo Penagos" class="login-logo">
            <h1>Acceso al Sistema</h1>
            <p>Herramienta de Dise√±o de Filtros Cicl√≥nicos v9.5</p>
            <form id="login-form">
                <div class="login-field"><label for="username">Usuario</label><input type="text" id="username" placeholder="Ingrese su usuario" value="PENAGOS"></div>
                <div class="login-field"><label for="password">Contrase√±a</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" placeholder="Ingrese su contrase√±a">
                        <button type="button" class="btn-icon" id="togglePassword" title="Mostrar/Ocultar contrase√±a">
                            <svg id="eye-open" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            <svg id="eye-closed" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                        </button>
                    </div>
                </div>
                <button type="submit" class="login-button">Ingresar</button>
            </form>
        </div>
    </div>

    <div class="app-wrapper" id="appWrapper">
        <div class="container">
            <header class="header">
                <div class="header-controls">
                    <button class="btn-icon" id="theme-toggle-btn" title="Cambiar Tema">
                        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                        <svg id="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" /></svg>
                    </button>
                    <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
                <img src="https://penagos.com/wp-content/uploads/2020/04/logo-2-300x129.png" alt="Logo Penagos" class="header-logo">
                <h1>üåÄ Herramienta de Dise√±o de Filtros Cicl√≥nicos v9.5</h1>
                <p>C√°lculo y optimizaci√≥n de filtros para gases de combusti√≥n de biomasa de caf√©</p>
            </header>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">Paso 1 de 3</div>
            </div>

            <main>
                <div class="step-card active" id="step1">
                    <div class="step-title"><div class="step-number">1</div>PAR√ÅMETROS DEL PROCESO Y GASES</div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="flowRate_m3s">Caudal (Q) en m¬≥/s</label>
                            <input type="number" id="flowRate_m3s" value="0.3" required>
                            <div class="collapsible-header" onclick="toggleCollapsible('info-q')">
                                <span>¬øQu√© es el caudal y c√≥mo lo obtengo?</span> <span class="arrow">‚ñ∂</span>
                            </div>
                            <div class="collapsible-content" id="info-q">
                                <p>Es el volumen de gas que el filtro debe procesar, medido en metros c√∫bicos por segundo (m¬≥/s). Puede obtener este valor de la ficha t√©cnica del ventilador del sistema.</p>
                            </div>
                        </div>
                        <div class="input-field">
                            <label for="inletVelocity_ms">Velocidad de Entrada (V·µ¢) en m/s</label>
                            <input type="number" id="inletVelocity_ms" value="18" required>
                            <div class="collapsible-header" onclick="toggleCollapsible('info-vi')">
                                <span>¬øCu√°l es la velocidad de entrada √≥ptima?</span> <span class="arrow">‚ñ∂</span>
                            </div>
                            <div class="collapsible-content" id="info-vi">
                                <p>Es la velocidad con la que el gas ingresa al cicl√≥n. Un rango √≥ptimo para alta eficiencia y baja ca√≠da de presi√≥n es de <strong>15 a 25 m/s</strong>.</p>
                            </div>
                        </div>
                    </div>
                     <div class="input-group">
                        <div class="input-field">
                            <label for="particleDensity">Densidad de Part√≠cula (œÅ‚Çö) en kg/m¬≥</label>
                            <input type="number" id="particleDensity" value="700" required>
                             <div class="collapsible-header" onclick="toggleCollapsible('info-rhop')">
                                <span>Densidad del polvo de cisco de caf√©</span> <span class="arrow">‚ñ∂</span>
                            </div>
                            <div class="collapsible-content" id="info-rhop">
                                <p>Es la densidad del material a separar. Para ceniza o polvo de cisco de caf√©, un valor entre <strong>600 y 800 kg/m¬≥</strong> es un buen punto de partida.</p>
                            </div>
                        </div>
                        <div class="input-field">
                            <label for="particleDiameterMicron">Di√°metro Objetivo (d‚Çö) en ¬µm</label>
                            <input type="number" id="particleDiameterMicron" value="10" required>
                            <div class="collapsible-header" onclick="toggleCollapsible('info-dp')">
                                <span>¬øQu√© part√≠cula debo elegir como objetivo?</span> <span class="arrow">‚ñ∂</span>
                            </div>
                            <div class="collapsible-content" id="info-dp">
                                <p>Es el tama√±o de la part√≠cula m√°s peque√±a que se desea capturar con alta eficiencia. Para cisco de caf√©, la mayor√≠a son mayores a 10 ¬µm. Un objetivo de <strong>5 a 15 ¬µm</strong> es com√∫n.</p>
                            </div>
                        </div>
                    </div>
                     <div class="input-group">
                        <div class="input-field">
                            <label for="gasDensity">Densidad del Gas (œÅ‚Çâ) en kg/m¬≥</label>
                            <input type="number" id="gasDensity" value="1.1" required>
                            <div class="collapsible-header" onclick="toggleCollapsible('info-gas')">
                                <span>Propiedades del Gas (Aire Caliente)</span> <span class="arrow">‚ñ∂</span>
                            </div>
                            <div class="collapsible-content" id="info-gas">
                                <p>Estos valores dependen de la temperatura. Para aire a 50¬∞C, la densidad es <strong>~1.1 kg/m¬≥</strong> y la viscosidad <strong>~1.95e-5 Pa¬∑s</strong>. Use estos valores por defecto si no est√° seguro.</p>
                            </div>
                        </div>
                        <div class="input-field">
                             <label for="gasViscosity">Viscosidad del Gas (¬µ) en Pa¬∑s</label>
                             <input type="text" id="gasViscosity" value="1.95e-5" required>
                        </div>
                    </div>
                    <div class="buttons">
                         <button class="btn btn-secondary" disabled>‚Üê Anterior</button>
                        <button class="btn btn-primary next-button-pulse" onclick="calcularPaso1()">Calcular y Continuar ‚Üí</button>
                    </div>
                    <div id="resultados1" class="calculation-display" style="display:none;"></div>
                </div>

                <div class="step-card" id="step2">
                    <div class="step-title"><div class="step-number">2</div>DISE√ëO, DIMENSIONAMIENTO Y RENDIMIENTO</div>
                    <div class="input-group">
                        <div class="input-field">
                            <label for="turns">N√∫mero de Vueltas Efectivas (N‚Çë)</label>
                            <input type="number" id="turns" value="6" step="1" required>
                             <div class="collapsible-header" onclick="toggleCollapsible('info-ne')">
                                <span>¬øQu√© son las vueltas efectivas?</span> <span class="arrow">‚ñ∂</span>
                            </div>
                            <div class="collapsible-content" id="info-ne">
                                <p>Representa cu√°ntas veces el gas circula dentro del cicl√≥n. A mayor N‚Çë, mayor eficiencia pero tambi√©n mayor ca√≠da de presi√≥n. Un valor entre <strong>5 y 8</strong> es un buen punto de partida.</p>
                            </div>
                        </div>
                        <div class="input-field">
                            <label for="lossFactor">Factor de P√©rdida (Œæ)</label>
                            <input type="number" id="lossFactor" value="8" step="0.5" required>
                            <div class="collapsible-header" onclick="toggleCollapsible('info-xi')">
                                <span>¬øQu√© es el factor de p√©rdida?</span> <span class="arrow">‚ñ∂</span>
                            </div>
                            <div class="collapsible-content" id="info-xi">
                                <p>Es un valor emp√≠rico para estimar la p√©rdida de presi√≥n. Un rango t√≠pico para ciclones industriales de alta eficiencia es de <strong>6 a 12</strong>.</p>
                            </div>
                        </div>
                    </div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="siguientePaso(1)">‚Üê Anterior</button>
                        <button class="btn btn-primary next-button-pulse" onclick="calcularPaso2()">Calcular Dimensiones y Rendimiento</button>
                    </div>
                    <div id="resultados2" class="calculation-display" style="display:none;"></div>
                    <div class="buttons" style="justify-content: flex-end;">
                        <button class="btn btn-primary" id="siguiente2" onclick="siguientePaso(3)" disabled>Finalizar y Ver Reporte ‚Üí</button>
                    </div>
                </div>

                <div class="step-card" id="step3">
                    <div class="step-title"><div class="step-number">3</div>FICHA T√âCNICA DE DISE√ëO</div>
                    <div class="input-field"><h4>üî© Material y Costo Estimado</h4></div>
                    <div class="input-group">
                         <div class="input-field">
                            <label for="materialType">Material Estructural</label>
                            <select id="materialType">
                                <option value="7850">Acero al Carbono A36 (7850 kg/m¬≥)</option>
                                <option value="8000">Acero Inoxidable 304 (8000 kg/m¬≥)</option>
                            </select>
                        </div>
                        <div class="input-field">
                            <label for="materialThickness">Espesor de L√°mina (mm)</label>
                            <input type="number" id="materialThickness" value="1.5" step="0.1" required>
                        </div>
                        <div class="input-field">
                            <label for="materialPrice">Precio del Material (COP/kg)</label>
                            <input type="number" id="materialPrice" value="5000" step="100" required>
                        </div>
                    </div>
                    <div class="input-field" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="generarReporteFinal()">Generar Ficha T√©cnica Completa</button>
                    </div>
                    <div id="reporteFinal" class="final-report" style="display:none;"></div>
                    <div class="buttons">
                        <button class="btn btn-secondary" onclick="siguientePaso(2)">‚Üê Anterior</button>
                        <div class="button-group">
                           <button class="btn btn-secondary" onclick="reiniciarCalculo()">üîÑ Nuevo An√°lisis</button>
                           <button class="btn btn-primary" id="pdfButton" onclick="descargarPDF()" disabled>üìÑ Descargar Ficha en PDF</button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <footer class="page-footer">
        <div class="footer-left">
            <a href="https://github.com/legend20021" target="_blank" rel="noopener noreferrer">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>
                <span>Desarrollado por Jonathan Jerez</span>
            </a>
        </div>
        <div class="footer-right" id="copyright"></div>
    </footer>
    
    <script>
        window.jsPDF = window.jspdf.jsPDF;
        let resultados = {};
        // Imagen del diagrama del cicl√≥n codificada en Base64 para que sea autocontenida
        const diagramBase64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEAAUDBAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChALCAgOCQgIDRUNDhERExMTCAsWGBYSGBASExIBBQUFCAcIDwkJDxIPEA4SEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEv/AABEIAeACgAMBIgACEQEDEQH/xAAcAAEAAQUBAQAAAAAAAAAAAAAABgECBAUHAwj/xABhEAABBAIAAwMECggQCwYFBQABAAIDBAURBhIhBxMxFCJBUTI1YXF1gZGhsbUVIzRCcnTB8AgWFyQlM1JVYoKTsrO0ttE2VmN2g5KVlqLV4VRkc8LT1ENEU6PxJoSUpsb/xAAbAQEAAQUBAAAAAAAAAAAAAAAAAQIDBAUGB//EADoRAQABAwEFBgMHAwIHAAAAAAABAgMRBAUSITFRQWFxgZGxEyIyBiOhwdHh8BQzclLxJDRCYoKSwv/wAFAQSkZJRgABAQAAAQABAAD/2wCEAAUDBAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChALCAgOCQgIDRUNDhERExMTCAsWGBYSGBASExIBBQUFCAcIDwkJDxIPEA4SEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEv/AABEIAeACgAMBIgACEQEDEQH/xAAcAAEAAQUBAQAAAAAAAAAAAAAABgECBAUHAwj/xABhEAABBAIAAwMECggQCwYFBQABAAIDBAURBhIhBxMxFCJBUTI1YXF1gZGhsbUVIzRCcnTB8AgWFyQlM1JVYoKTsrO0ttE2VmN2g5KVlqLV4VRkc8LT1ENEU6PxJoSUpsb/xAAbAQEAAQUBAAAAAAAAAAAAAAAAAQIDBAUGB//EADoRAQABAwEFBgMHAwIHAAAAAAABAgMRBAUSITFRQWFxgZGxEyIyBiOhwdHh8BQzclLxJDRCYoKSwv/aAAwDAQACERAQAIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiIgIiICxsnGjYjkmeGSxNc97nODWta0FznOcegaAAST4ALJQRjsz4hyWWqY1+P4Tykd+7JmZLE12sDHFJdlnqY+fX33yQY2O9eQ+Fh0t1fF3GVPF132bUjYoYx6SS4kklrWNaCXOcT0AAJPqUCyWJzOW4hyB7jHjsZl3R41p0C2bFXuDHOwQh2xL3h2v17YfMCNW1jK0teOGCFvLHBFHFGw+DWtaGj5gs+OqLd0Qv0mY6Q8M+0P9d3/wDhX/r+787Fv8H3h4j8n1hN1y/EHBlyfKZO5Nw7gcoy1LB5LLdyk0MzYYKscAZIwYiUMDntc7Qc7XP6V17SoWg+hBp+C8ZNTx1GpYsG3YrVIIJrRbymxLFG1j5i0udy8zgTrZ8fFbdXaTSCiKuk0goirpNIKIq6TSCiKuk0gIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiIP/Z';

        document.addEventListener('DOMContentLoaded', () => {
            const loginOverlay = document.getElementById('login-overlay');
            const appWrapper = document.getElementById('appWrapper');
            const themeBtn = document.getElementById('theme-toggle-btn');
            const passwordToggle = document.getElementById('togglePassword');
            
            updateTheme(localStorage.getItem('theme') || 'dark');
            
            if (localStorage.getItem('isLoggedIn') === 'true') {
                loginOverlay.classList.add('hidden');
                document.body.style.overflow = 'auto';
                appWrapper.classList.add('visible');
            } else {
                loginOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                appWrapper.classList.remove('visible');
            }
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            themeBtn.addEventListener('click', handleThemeToggle);
            passwordToggle.addEventListener('click', togglePasswordVisibility);
            document.getElementById('copyright').innerHTML = `&copy; ${new Date().getFullYear()} Penagos Hermanos. Todos los derechos reservados.`;
        });
        
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const storedObfuscatedPass = 'cGVuYWdvczEyMw=='; // btoa('penagos123')
            const enteredObfuscatedPass = btoa(password);

            if (username.toUpperCase() === 'PENAGOS' && enteredObfuscatedPass === storedObfuscatedPass) {
                localStorage.setItem('isLoggedIn', 'true');
                document.getElementById('login-overlay').classList.add('hidden');
                document.body.style.overflow = 'auto';
                document.getElementById('appWrapper').classList.add('visible');
            } else {
                const loginBox = document.getElementById('loginBox');
                loginBox.classList.add('error-shake');
                setTimeout(() => { loginBox.classList.remove('error-shake'); }, 500);
            }
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function updateTheme(theme) {
            const isLight = theme === 'light';
            document.body.classList.toggle('light-mode', isLight);
            document.getElementById('sun-icon').style.display = isLight ? 'none' : 'block';
            document.getElementById('moon-icon').style.display = isLight ? 'block' : 'none';
            localStorage.setItem('theme', theme);
        }

        function handleThemeToggle() {
            const newTheme = document.body.classList.contains('light-mode') ? 'dark' : 'light';
            if (!document.startViewTransition) {
                updateTheme(newTheme);
                return;
            }
            document.startViewTransition(() => updateTheme(newTheme));
        }
        
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('password');
            const eyeOpen = document.getElementById('eye-open');
            const eyeClosed = document.getElementById('eye-closed');
            const isPassword = passwordInput.type === 'password';
            
            passwordInput.type = isPassword ? 'text' : 'password';
            eyeOpen.style.display = isPassword ? 'none' : 'block';
            eyeClosed.style.display = isPassword ? 'block' : 'none';
        }

        function reiniciarCalculo() {
            siguientePaso(1);
            resultados = {};
            document.getElementById('resultados1').style.display = 'none';
            document.getElementById('resultados2').style.display = 'none';
            document.getElementById('reporteFinal').style.display = 'none';
            document.getElementById('siguiente2').disabled = true;
            document.getElementById('pdfButton').disabled = true;
        }

        function siguientePaso(paso) {
            document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
            document.getElementById(`step${paso}`).classList.add('active');
            window.scrollTo(0, 0);
            if (paso === 3) {
                document.getElementById('reporteFinal').style.display = 'none';
                document.getElementById('pdfButton').disabled = true;
            }
            const titulos = ["Par√°metros y Gases", "Dise√±o y Rendimiento", "Reporte Final"];
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = (paso / 3) * 100 + '%';
            progressBar.textContent = `Paso ${paso} de 3: ${titulos[paso-1]}`;
        }
        
        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            const header = content.previousElementSibling;
            content.classList.toggle('show');
            header.classList.toggle('active');
        }

        function parseScientificNotation(string) {
            const parts = string.toLowerCase().split('e');
            if (parts.length === 2) {
                return parseFloat(parts[0]) * Math.pow(10, parseInt(parts[1]));
            }
            return parseFloat(string);
        }

        function calcularPaso1() {
            const Q_m3s = parseFloat(document.getElementById('flowRate_m3s').value);
            const Vi_ms = parseFloat(document.getElementById('inletVelocity_ms').value);

            if (isNaN(Q_m3s) || isNaN(Vi_ms) || Q_m3s <= 0 || Vi_ms <= 0) {
                alert('Por favor, ingrese valores num√©ricos v√°lidos y positivos para caudal y velocidad.');
                return;
            }

            const A_inlet = Q_m3s / Vi_ms;
            let velocidadMensaje = '';
            let isValid = true;

            if (Vi_ms < 15) {
                velocidadMensaje = `<strong style="color: #f59e0b;">‚ö†Ô∏è BAJA VELOCIDAD:</strong> La velocidad de ${Vi_ms.toFixed(2)} m/s es inferior al √≥ptimo (15-25 m/s). Esto puede reducir la eficiencia de separaci√≥n.`;
                isValid = false;
            } else if (Vi_ms > 25) {
                velocidadMensaje = `<strong style="color: #f87171;">‚ùå ALTA VELOCIDAD:</strong> La velocidad de ${Vi_ms.toFixed(2)} m/s es superior al √≥ptimo (15-25 m/s). Esto puede causar una ca√≠da de presi√≥n excesiva y erosi√≥n del material.`;
                isValid = false;
            } else {
                velocidadMensaje = `<strong style="color: #22c55e;">‚úÖ VELOCIDAD √ìPTIMA:</strong> La velocidad de ${Vi_ms.toFixed(2)} m/s est√° en el rango recomendado.`;
            }

            resultados.paso1 = { Q_m3s, Vi_ms, A_inlet, isValid };
            
            document.getElementById('resultados1').innerHTML = `
                <h4>üìä Resultados Preliminares:</h4>
                <div class="result-highlight">
                    <strong>√Årea de Entrada Requerida (A):</strong> ${A_inlet.toFixed(4)} m¬≤<br>
                    <small>(Calculada a partir de un caudal de ${Q_m3s.toFixed(2)} m¬≥/s y una velocidad de ${Vi_ms.toFixed(2)} m/s)</small>
                </div>
                <div class="result-highlight">
                    ${velocidadMensaje}
                </div>`;
            document.getElementById('resultados1').style.display = 'block';
            
            if (isValid) {
                siguientePaso(2);
            } else {
                 alert("La velocidad de entrada est√° fuera del rango √≥ptimo. Por favor, aj√∫stela para continuar.");
            }
        }

        function calcularPaso2() {
            if (!resultados.paso1) { alert('Primero debe completar el Paso 1.'); return; }
            
            const rho_p = parseFloat(document.getElementById('particleDensity').value);
            const dp_goal_um = parseFloat(document.getElementById('particleDiameterMicron').value);
            const rho_g = parseFloat(document.getElementById('gasDensity').value);
            const mu = parseScientificNotation(document.getElementById('gasViscosity').value);
            const Ne = parseFloat(document.getElementById('turns').value);
            const xi = parseFloat(document.getElementById('lossFactor').value);
            
            const { Vi_ms, Q_m3s, A_inlet } = resultados.paso1;

            if (isNaN(rho_p) || isNaN(dp_goal_um) || isNaN(rho_g) || isNaN(mu) || isNaN(Ne) || isNaN(xi)) {
                alert('Por favor, ingrese valores num√©ricos v√°lidos en todos los campos.');
                return;
            }
            
            // C√°lculo del di√°metro del cicl√≥n (Dc) basado en proporciones est√°ndar de Lapple (A = 0.1 * Dc^2)
            const Dc_m = Math.sqrt(A_inlet / 0.1);

            // Dimensiones basadas en Dc y las relaciones de Lapple
            const dim = {
                Dc: Dc_m, a: 0.5 * Dc_m, b: 0.2 * Dc_m,
                Ds: 0.5 * Dc_m, S: 0.5 * Dc_m, h: 1.5 * Dc_m,
                H: 4.0 * Dc_m, z: 2.5 * Dc_m, B: 0.375 * Dc_m
            };

            // Di√°metro de corte (Dpc) en metros
            const dpc_m = Math.sqrt((9 * mu * dim.b) / (2 * Math.PI * Ne * Vi_ms * (rho_p - rho_g)));
            const dpc_um = dpc_m * 1e6;

            // Eficiencia de recolecci√≥n (Œ∑) para la part√≠cula objetivo
            const dp_goal_m = dp_goal_um * 1e-6;
            const efficiency = 1 / (1 + Math.pow(dpc_m / dp_goal_m, 2));

            // Ca√≠da de presi√≥n (ŒîP) en Pascales
            const deltaP_Pa = (xi * rho_g * Math.pow(Vi_ms, 2)) / 2;

            resultados.paso2 = {
                dim, dpc_um, efficiency, deltaP_Pa,
                // Guardar tambi√©n las entradas para el reporte
                rho_p, dp_goal_um, rho_g, mu, Ne, xi
            };

            document.getElementById('resultados2').innerHTML = `
                <h4>üìê Dimensiones del Cicl√≥n (Est√°ndar Lapple):</h4>
                <div class="result-highlight">
                    <strong>Di√°metro del Cicl√≥n (Dc):</strong> ${dim.Dc.toFixed(3)} m (${(dim.Dc * 100).toFixed(1)} cm)<br>
                    <strong>Entrada (a x b):</strong> ${dim.a.toFixed(3)} m √ó ${dim.b.toFixed(3)} m<br>
                    <strong>Altura Total (H):</strong> ${dim.H.toFixed(3)} m (${(dim.H * 100).toFixed(1)} cm)
                </div>
                <h4>üìà Rendimiento Estimado:</h4>
                <div class="result-highlight">
                    <strong>Di√°metro de Corte (dpc): ${dpc_um.toFixed(2)} ¬µm</strong><br>
                    <small>Part√≠culas m√°s grandes que esto ser√°n capturadas con >50% de eficiencia.</small>
                </div>
                <div class="result-highlight" style="border-left-color: ${efficiency > 0.9 ? '#22c55e' : '#f59e0b'};">
                    <strong>Eficiencia de Recolecci√≥n (Œ∑): ${(efficiency * 100).toFixed(1)}%</strong> para part√≠culas de ${dp_goal_um} ¬µm.
                </div>
                 <div class="result-highlight">
                    <strong>Ca√≠da de Presi√≥n (ŒîP): ${deltaP_Pa.toFixed(2)} Pa</strong><br>
                    <small>Esta es la p√©rdida de energ√≠a que el ventilador debe superar.</small>
                </div>`;
            document.getElementById('resultados2').style.display = 'block';
            document.getElementById('siguiente2').disabled = false;
        }

        function generarReporteFinal() {
            if (!resultados.paso1 || !resultados.paso2) {
                alert('Por favor, complete todos los pasos anteriores.');
                return;
            }

            const materialDensity = parseFloat(document.getElementById('materialType').value);
            const materialSelect = document.getElementById('materialType');
            const materialName = materialSelect.options[materialSelect.selectedIndex].text.split('(')[0].trim();
            const materialThickness_mm = parseFloat(document.getElementById('materialThickness').value);
            const materialThickness_m = materialThickness_mm / 1000;
            const materialPrice = parseFloat(document.getElementById('materialPrice').value);
            
            const r2 = resultados.paso2;
            const dim = r2.dim;
            
            // C√°lculo de √°rea de l√°mina (aproximado)
            const area_cilindro = Math.PI * dim.Dc * dim.h;
            const radio_base_cono = dim.Dc / 2;
            const radio_salida_cono = dim.B / 2;
            const slant_height = Math.sqrt(Math.pow(dim.z, 2) + Math.pow(radio_base_cono - radio_salida_cono, 2));
            const area_cono = Math.PI * (radio_base_cono + radio_salida_cono) * slant_height;
            const area_tapa = Math.PI * Math.pow(dim.Dc / 2, 2) - Math.PI * Math.pow(dim.Ds / 2, 2); // Tapa con hueco
            const area_total = area_cilindro + area_cono + area_tapa;
            
            const materialVolume = area_total * materialThickness_m;
            const materialWeight = materialVolume * materialDensity;
            const materialCost = materialWeight * materialPrice;

            resultados.paso3 = { materialName, materialThickness_mm, materialPrice, area_total, materialWeight, materialCost };
            
            document.getElementById('reporteFinal').innerHTML = generarReporteHTML();
            document.getElementById('reporteFinal').style.display = 'block';
            document.getElementById('pdfButton').disabled = false;
        }

        function generarReporteHTML() {
            const r1 = resultados.paso1;
            const r2 = resultados.paso2;
            const r3 = resultados.paso3;
            
            const tableData = [
                // Secci√≥n 1: Datos Generales
                [
                    {label: "Fecha de C√°lculo", value: new Date().toLocaleDateString('es-CO')}, 
                    {label: "Tipo de Part√≠cula", value: "Ceniza/Polvo de Cisco de Caf√©"}
                ],
                // Secci√≥n 2: Rendimiento
                [
                    {label: "Caudal de Dise√±o (Q)", value: `${r1.Q_m3s.toFixed(2)} m¬≥/s`}, 
                    {label: "Velocidad de Entrada (V·µ¢)", value: `${r1.Vi_ms.toFixed(2)} m/s`}, 
                    {label: "Di√°metro de Corte (dpc)", value: `<strong>${r2.dpc_um.toFixed(2)} ¬µm</strong>`}, 
                    {label: "Eficiencia de Colecci√≥n (Œ∑)", value: `<strong>${(r2.efficiency * 100).toFixed(1)}%</strong> para ${r2.dp_goal_um} ¬µm`}, 
                    {label: "Ca√≠da de Presi√≥n (ŒîP)", value: `<strong>${r2.deltaP_Pa.toFixed(2)} Pa</strong>`}
                ],
                // Secci√≥n 3: Dimensiones
                [
                    {label: "Di√°metro del Cicl√≥n (Dc)", value: `${r2.dim.Dc.toFixed(3)} m (${(r2.dim.Dc * 100).toFixed(1)} cm)`},
                    {label: "Altura Total (H)", value: `${r2.dim.H.toFixed(3)} m (${(r2.dim.H * 100).toFixed(1)} cm)`},
                    {label: "Ancho de Entrada (a)", value: `${r2.dim.a.toFixed(3)} m`},
                    {label: "Altura de Entrada (b)", value: `${r2.dim.b.toFixed(3)} m`},
                    {label: "Di√°metro Salida Gas (Ds)", value: `${r2.dim.Ds.toFixed(3)} m`},
                    {label: "Altura Cuerpo Cil√≠ndrico (h)", value: `${r2.dim.h.toFixed(3)} m`},
                    {label: "Altura del Cono (z)", value: `${r2.dim.z.toFixed(3)} m`},
                    {label: "Di√°metro Salida Polvo (B)", value: `${r2.dim.B.toFixed(3)} m`}
                ],
                // Secci√≥n 4: Materiales y Costo
                [
                    {label: "Material Estructural", value: r3.materialName},
                    {label: "Espesor de L√°mina", value: `${r3.materialThickness_mm} mm`},
                    {label: "√Årea de L√°mina Aprox.", value: `${r3.area_total.toFixed(2)} m¬≤`},
                    {label: "Peso Total Estimado", value: `<strong>${r3.materialWeight.toFixed(1)} kg</strong>`},
                    {label: "Costo Aprox. Material", value: `<strong>$${r3.materialCost.toLocaleString('es-CO', {maximumFractionDigits: 0})} COP</strong>`}
                ]
            ];
            
            const titles = [
                "FICHA T√âCNICA DE DISE√ëO: Filtro Cicl√≥nico (Penagos)",
                "Especificaciones de Rendimiento del Sistema",
                "Par√°metros Constructivos y Geom√©tricos",
                "Materiales, Peso y Costo Estimado"
            ];
            
            let reportHTML = '';
            titles.forEach((title, index) => {
                reportHTML += `<div class="report-section"><h3>${title}</h3>`;
                reportHTML += `<table class="report-table"><tbody>`;
                tableData[index].forEach(row => {
                    reportHTML += `<tr><td data-label="${row.label}">${row.label}</td><td data-label="${row.label}">${row.value}</td></tr>`;
                });
                reportHTML += `</tbody></table></div>`;
            });
            
            reportHTML += `<div class="results-image-container">
                <h3>Diagrama de Dimensiones (Est√°ndar Lapple)</h3>
                <img src="ciclon.png" alt="Diagrama de un filtro cicl√≥nico con sus dimensiones etiquetadas" style="display:block; margin:auto; max-width:80%;">
                <p><strong>Nomenclatura:</strong> Dc: Di√°metro del cicl√≥n | Ds: Di√°metro de salida de gas | a: Ancho de la entrada | b: Altura de la entrada<br>S: Altura de la salida de gas | h: Altura del cuerpo | z: Altura del cono | B: Di√°metro de la salida de polvo</p>
            </div>`;

            reportHTML += `<div class="report-footer">Herramienta de c√°lculo v9.5 desarrollada por Jonathan Jerez para Penagos Hermanos.</div>`;
            return reportHTML;
        }

        function descargarPDF() {
            const pdfButton = document.getElementById('pdfButton');
            pdfButton.disabled = true;
            pdfButton.innerHTML = 'Generando PDF...';

            const step3Card = document.getElementById('step3');
            const reporte = document.getElementById('reporteFinal');
            const isLightMode = document.body.classList.contains('light-mode');
            
            step3Card.classList.add('pdf-render-prep');
            
            html2canvas(reporte, { scale: 2, useCORS: true, backgroundColor: isLightMode ? '#ffffff' : '#1f2937' }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const imgProps= pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth() - 20;
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                let heightLeft = pdfHeight;
                let position = 10;
                
                pdf.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
                heightLeft -= (pdf.internal.pageSize.getHeight() - 20);
                
                while (heightLeft > 0) {
                  position = - (pdf.internal.pageSize.getHeight() * (pdf.internal.getNumberOfPages() -1)) + 10;
                  pdf.addPage();
                  pdf.addImage(imgData, 'PNG', 10, position, pdfWidth, pdfHeight);
                  heightLeft -= (pdf.internal.pageSize.getHeight() - 20);
                }
                pdf.save(`Ficha-Tecnica-Ciclon-${new Date().toISOString().slice(0,10)}.pdf`);
            }).catch(error => {
                console.error("Error al generar el PDF:", error);
                alert("Ocurri√≥ un error al generar el PDF.");
            }).finally(() => {
                step3Card.classList.remove('pdf-render-prep');
                pdfButton.innerHTML = 'üìÑ Descargar Ficha en PDF';
                pdfButton.disabled = false;
            });
        }
    </script>
</body>
</html>
